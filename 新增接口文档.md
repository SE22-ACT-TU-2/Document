# 新增接口文档

## 数据库

### 1.场地表（新增）

```python
# 场地
class Ground(models.Model):
    objects = models.Manager()
    name = models.CharField(max_length=30, verbose_name="场地名称")
    area = models.CharField(max_length=50, null=True, blank=True, verbose_name="场地区域")
    price = models.FloatField(verbose_name="价格", default=0, validators=[MinValueValidator(1)])
    apply_needed = models.BooleanField(verbose_name="是否需要预约", default=False)
    description = models.CharField(max_length=500, null=True, blank=True, verbose_name="场地信息")
    avatar = models.CharField(max_length=500, null=True, blank=True, verbose_name="场地图片")
    administrator = models.ForeignKey('SuperAdmin', on_delete=models.CASCADE, verbose_name="场地管理员")
```

### 2. 场地申请表（新增）

```python
# 场地申请
class GroundApply(models.Model):
    objects = models.Manager()
    STATE = (
        (0, '已通过'),
        (1, '审核中'),
        (2, '已失效')
    )
    IDENTITY = (
        (0, '普通用户'),
        (1, '组织者')
    )
    ground_id = models.ForeignKey('Ground', on_delete=models.CASCADE, verbose_name="申请场地id")
    user_id = models.ForeignKey('WXUser', on_delete=models.CASCADE, verbose_name="申请用户id")
    begin_time = models.DateTimeField(verbose_name="申请开始时间", default="2001-01-01 00:00:00")
    end_time = models.DateTimeField(verbose_name="申请结束时间", default="2001-01-01 00:00:00")
    state = models.SmallIntegerField(choices=STATE, default=0, verbose_name="申请状态")
    feedback = models.CharField(max_length=500, verbose_name="申请反馈")
    can_change = models.BooleanField(verbose_name="是否可改期", default=False)
    file = models.CharField(max_length=500, null=True, verbose_name="申请材料")
    identity = models.SmallIntegerField(choices=IDENTITY, default=0, verbose_name="申请者身份")
    apply_group = models.SmallIntegerField(default=0, verbose_name="预约组号")

```

### 3. 审核用户表（新增）

```python
# 审核用户
class UserVerify(models.Model):
    objects = models.Manager()
    user_id = models.ForeignKey('WXUser', on_delete=models.CASCADE, verbose_name="审核用户id")
    name = models.CharField(max_length=30, verbose_name="用户名称")
    student_number = models.CharField(max_length=20, verbose_name="学号")
    avatar = models.CharField(max_length=500, verbose_name="校园卡图片")
```

### 4. 用户表（修改）

```python
# 用户
class WXUser(models.Model):
    objects = models.Manager()
    openid = models.CharField(unique=True, verbose_name="微信openid", max_length=500, help_text="微信openid --string")
    name = models.CharField(max_length=30, verbose_name="昵称", help_text="昵称 --string")
    avatar = models.CharField(max_length=500, null=True, blank=True, verbose_name="头像", help_text="头像 --string")
    email = models.EmailField(max_length=100, null=True, verbose_name="邮箱", help_text="邮箱 --string")
    sign = models.CharField(max_length=200, null=True, blank=True, verbose_name="个性签名", help_text="个性签名 --string")
    contact = models.CharField(max_length=50, verbose_name="联系方式", null=True, blank=True, help_text="联系方式 --string")
    follow_boya = models.BooleanField(verbose_name="是否关注博雅版块", default=False)
    user_portrait = models.CharField(max_length=200, null=True, blank=True, verbose_name="用户画像路径")
    '''--------------------------------------------------'''
    defaults_number = models.IntegerField(verbose_name="违约次数", default=0, validators=[MinValueValidator(1)])
    money = models.FloatField(verbose_name="钱包", default=0, validators=[MinValueValidator(1)])
    is_csstd = models.BooleanField(verbose_name="是否是院内学生", default=False)
    student_id = models.CharField(max_length=10, null=True, blank=True, verbose_name="学号")
```

### 5. 超级管理员表（修改）

```python
# 超级管理员
class SuperAdmin(User):
    objects = models.Manager()
    avatar = models.CharField(max_length=500, null=True, blank=True, verbose_name="头像")
    '''--------------------------------------------------'''
    type = models.CharField(max_length=50, verbose_name="管理员类别", default="normal")
```



## 用户端接口

### 场地预约视图

### 1. 查询已占用场地 POST `sites/used/`

**权限**
用户端

**说明**

```python
def get_used_ground(self, request):
    """
        输入：date日期，area区域，ground_id场地id

        第一种情况：查询该日期该区域中所有场地的被占用情况，这时ground_id=-1忽略
        第二种情况：查询该日期该场地的被占用情况，这是ground_id有效，area为空串

        输出：该日期该区域所有场地（某个场地）被占用情况
            每一个场地为一项，包括ground_id，ground_name，period，
            其中period为长度14的列表，代表8到22点，1表示被占用（被成功预约或者审核中），0表示未被预约
            区域查询则输出多条，单场地查询则输出一条
    """
```

**Request**
http://127.0.0.1:8000/sites/used/

**Body**

```json
{
	"date": "", // "2022-04-18"
	"area": "", // "乒乓球场"
    "ground_id": int // 1 ,-1
}
```

**Success Response**
状态码：201
Body

```json
[
	{
		"ground_id": int,
		"ground_name": "",
         "period": []	  //暂定8点到22点，用14位的list表示
		//例如:8到10，20到21被占用，则返回[1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0]
	},
	{
		...
	}
]
```

### 2. 预约场地 POST `sites/`

**权限**
用户端

**说明**
预约场地
普通预约：一次提交一个预约单{场地,时间段}，若要实现分散的预约，需要多次预约，后端入库检查是否已经达到预约时长上限
批量预约：可以一次提交多个预约单[{场地,时间段}]，需要提交申请理由，后端入库时将其预约组号设为同一个

注意：后端需要为批量预约分配一个相同的apply_group

**Request**
http://127.0.0.1:8000/sites/

**Body**

```json
{
    "user_id": int,
    "identity": int,
    "file":	"",
    "ground_times":[
        {
            "ground_id": int,
            "date": "", //"2022-04-18"
        	"begin_time": int,  //17
        	"end_time":  int    //18
        },
        {
            ...
        }
    ]
}
```

**Success Response**
状态码：201
Body

```json
{
	"msg":	"预约成功"/"已提交申请，等待审核"
}
```

### 3. 查询我的预约 GET `users/booked_ground/{id}/`

**权限**
用户端

**说明**
查询指定id用户的所有场地预约

**Request**
http://127.0.0.1:8000/users/booked_ground/1/

**Body**
无

**Success Response**
状态码：201
Body

```json
{//预约成功 审核中 已失效
	"success": [
        {	
             "apply_id": int,
			"user_id": int,
			"ground_id": int,
			"area1": ""// "乒乓球馆"
			"area2": ""// "乒乓球一号台"
			"date": "", // "2022-04-18"
			"begin_time": int, // 10
			"end_time": int, // 12
			"feedback": ""//"已改期"
			"identity":int,// 0 普通预约 1 批量预约
			"can_change":bool //是否可以改期
        }
    ],
    "checking": [],
    "invalid": []
}
```



### 4. 预约改期 POST `users/booked_ground/`

**权限**
用户端

**说明**
预约改期

**Request**
http://127.0.0.1:8000/users/booked_ground/

**Body**

```json
{
	"apply_id": int,
    "date": "", // "2022-04-18"
    "begin_time": int, //10
    "end_time": int, //12
    "file": ""
}
```

**Success Response**
状态码：201
Body

```json
{
	"msg":	"改期成功"/"已提交申请，等待审核"
}
```

### 5. 取消预约 DELETE `users/booked_ground/{apply_id}/`

**权限**
用户端

**说明**
取消预约

**Request**
http://127.0.0.1:8000/users/booked_ground/1/

**Body**
无

**Success Response**
状态码：201
Body

```json
{
	"msg": "取消成功"，
	"defaults_number": int
}
```

### 用户视图

### 6. 查询钱包 GET `users/wallet/{id}/`

**权限**
用户端

**说明**
获取指定id用户的钱包余额

**Request**
http://127.0.0.1:8000/users/wallet/1/

**Body**
无

**Success Response**
状态码：201
Body

```json
{
	"money": float
}
```

### 7. 充值 POST `users/wallet/`

**权限**
用户端

**说明**
充值

**Request**
http://127.0.0.1:8000/users/wallet/

**Body**

```json
{
	"user_id": int,
	"money": float
}
```

**Success Response**
状态码：201
Body

```json
{
	"msg": "充值成功"
}
```

### 用户审核视图

### 8.

